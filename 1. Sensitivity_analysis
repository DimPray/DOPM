'''
coding:utf-8
@Software:PyCharm
@Time:2024/7/25 10:33
@Author:Prayer_dm
'''
import pandas as pd
from scipy.stats import pearsonr
import math

input_path = "I:/Task_Exposure/15.sensitivity_analysis/input/"
output_path = "I:/Task_Exposure/15.sensitivity_analysis/output/"

Emission = pd.read_excel(input_path + "Point_emission_sources.xlsx", index_col='FID')
Sites_receptor = pd.read_excel(input_path + "Monitoring_sites.xlsx", index_col='FID')  # Pop_virtual_receptors
Efficiency = pd.read_excel(input_path + "Emission_efficiency.xlsx", index_col='FID')

# Gaussian weighting function-aided Proximity Model
# 1. calculate Euclidean distance from each Pes to each Vr
Distance = []
for i in range(0, len(Emission)):
    Dis_sum = []
    for j in range(0, len(Sites_receptor)):
        Dis = math.sqrt((Emission.loc[i, 'X'] - Sites_receptor.loc[j, 'X'])**2
                         + (Emission.loc[i, 'Y'] - Sites_receptor.loc[j, 'Y'])**2)  # Euclidean distance
        Dis_sum.append(Dis)
    Distance.append(Dis_sum)
result_1 = pd.DataFrame(data=Distance, index=Emission.index, columns=Sites_receptor.index.T)

# 2. extract the minimum distance points which distance <= 50km
result_2 = result_1.T  # len = 11, column = 40
bandwidth = [5, 5.5, 6, 6.5, 7, 7.5, 8, 8.5, 9, 9.5, 10, 10.5, 11, 11.5, 12]  # define bandwidth , 6, 7, 8, 9, 10

Results_b = pd.DataFrame()
for b in bandwidth:

    Risk_sum = []
    for i in range(0, len(result_2)):  # 遍历11个站点
        Risk_j = 0
        for j in range(0, len(result_2.columns)):
            if result_2.iloc[i, j] <= b * 1000.0:
                W_j = (1 - ((result_2.iloc[i, j]) / (b * 1000.0)) ** 2) ** 2
                Risk = Efficiency.loc[j, 'E'] * W_j
                Risk_j = Risk_j + Risk
        Risk_sum.append(Risk_j)

    Risk_sum = pd.DataFrame(data=Risk_sum, index=Sites_receptor.index, columns=['R_' + str(b) + 'km'])
    Results_b = pd.concat([Results_b, Risk_sum], axis=1)

pearson_corr_sum = []
print(len(Results_b.columns))
for r in range(0, len(Results_b.columns)):
    Y = Sites_receptor.loc[:, 'GT']
    X_r = Results_b.iloc[:, r]
    pearson_corr, _ = pearsonr(Y, X_r)
    pearson_corr_sum.append(pearson_corr)
print(pearson_corr_sum)
Pearson = pd.DataFrame(data=pearson_corr_sum, index=Results_b.columns, columns=['R'])
Pearson.to_excel(output_path + "Sensitivity_analysis.xlsx", index=True)

print("Bandwidth -- sensitivity analysis -- finish!")
